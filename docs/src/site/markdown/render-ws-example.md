# Render Web Services Example

The following workflow steps demonstrate how the [render web services] and [Java clients]
can be used for a small example project.

The example assumes that:
* you have completed the [render web services basic installation steps](#basic-installation), 
* you are running on the installation server, and 
* you run the first (Setup Environment) step from the cloned render repository root directory (./render). 


### 1. Setup Environment

Define common script invocation variables first to simplify subsequent steps.

```bash
# assumes current directory is still the cloned render repository root (./render)

export CLIENT_SCRIPTS=`readlink -m ./render-ws-java-client/src/main/scripts`
export EXAMPLE_1_PARAMS="--baseDataUrl http://localhost:8080/render-ws/v1 --owner demo --project example_1"
export EXAMPLE_1_DIR=`readlink -m ./examples/example_1`
```


### 2. Import Acquisition Data

Import tile specs and shared transform specs created by the acquisition system (scopes).

```bash
# a) create v1_acquire stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_acquire --action CREATE --cycleNumber 1 --cycleStepNumber 1 

# b) import v1_acquire tile and transform data
${CLIENT_SCRIPTS}/import_json.sh ${EXAMPLE_1_PARAMS} --stack v1_acquire --disableValidation --transformFile ${EXAMPLE_1_DIR}/cycle1_step1_acquire_transforms.json ${EXAMPLE_1_DIR}/cycle1_step1_acquire_tiles.json 

# c) complete v1_acquire stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_acquire --action SET_STATE --stackState COMPLETE
```

The following URLs can be used to view dynamic renderings of the imported data (if your browser/client isn't 
running on the same host as the service, you'll need to change the host name in these URLs):
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_acquire/z/3407/box/0,0,4000,6000,0.25/jpeg-image>
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_acquire/z/3408/box/0,0,4000,6000,0.25/jpeg-image>


### 3. Import Intra-Layer Alignment Data (Montage) 

Import transform data generated by an alignment process that was optimized for alignment of tiles in the same plane (z). 

```bash
# a) create v1_montage stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_montage --action CREATE --cycleNumber 1 --cycleStepNumber 2

# b) apply v1_montage transform data to existing v1_acquire data, storing results in v1_montage stack
${CLIENT_SCRIPTS}/import_transform_changes.sh ${EXAMPLE_1_PARAMS} --stack v1_acquire --targetStack v1_montage --transformFile ${EXAMPLE_1_DIR}/cycle1_step2_montage_changes.json 

# c) complete v1_montage stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_montage --action SET_STATE --stackState COMPLETE
```

The following URLs can be used to view dynamic renderings of the imported data:
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_montage/z/3407/box/0,0,4000,6000,0.25/jpeg-image>
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_montage/z/3408/box/0,0,4000,6000,0.25/jpeg-image>


### 4. Import Inter-Layer Alignment Data (Align)

Import transform data generated by an alignment process that was optimized for alignment of tiles between adjacent planes (z). 

```bash
# a) create v1_align stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_align --action CREATE --cycleNumber 1 --cycleStepNumber 3

# b) apply v1_align transform data to existing v1_acquire data, storing results in v1_align stack
${CLIENT_SCRIPTS}/import_transform_changes.sh ${EXAMPLE_1_PARAMS} --stack v1_acquire --targetStack v1_align --transformFile ${EXAMPLE_1_DIR}/cycle1_step3_align_changes.json 

# c) complete v1_align stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_align --action SET_STATE --stackState COMPLETE
```

The following URLs can be used to view dynamic renderings of the imported data:
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_align/z/3407/box/0,0,4000,6000,0.25/jpeg-image>
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_align/z/3408/box/0,0,4000,6000,0.25/jpeg-image>


### 5. Refine Inter-Layer Alignment Data (Align TPS)

Use Thin Plate Spline algorithm to warp the v1_align data based upon tile centers of the v1_montage data, creating 
a refined three dimensional alignment. 

```bash
# a) create v1_align_tps stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_align_tps --action CREATE --cycleNumber 1 --cycleStepNumber 4

# b) warp v1_align stack to v1_montage stack, storing results in v1_align_tps stack
${CLIENT_SCRIPTS}/generate_warp_transforms.sh ${EXAMPLE_1_PARAMS} --alignStack v1_align --montageStack v1_montage --targetStack v1_align_tps  

# c) complete v1_align_tps stack
${CLIENT_SCRIPTS}/manage_stacks.sh ${EXAMPLE_1_PARAMS} --stack v1_align_tps --action SET_STATE --stackState COMPLETE
```

The following URLs can be used to view dynamic renderings of the imported data:
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_align/z/3407/box/0,0,4000,6000,0.25/jpeg-image>
* <http://localhost:8080/render-ws/v1/owner/demo/project/example_1/stack/v1_align/z/3408/box/0,0,4000,6000,0.25/jpeg-image>


  [Java clients]: <render-ws-java-client.md>
  [render web services]: <render-ws.md>
  [render web services basic installation steps]: <render-ws.md>
  
    
          @Parameter(names = "--disableValidation", description = "Disable flyTEM tile validation", required = false, arity = 0)
          private boolean disableValidation;
  
          @Parameter(description = "Z values", required = true)
          private List<String> zValues;
